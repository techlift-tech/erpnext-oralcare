!function(){"use strict";frappe.provide("frappe.views"),function(){var n="frappe.desk.doctype.kanban_board.kanban_board.",a=fluxify.createStore({id:"store",initialState:{doctype:"",board:{},card_meta:{},cards:[],columns:[],filters_modified:!1,cur_list:{},empty_state:!0},actionCallbacks:{init:function(n,a){n.set({empty_state:!0});var o=a.board,r=a.card_meta;a.card_meta=r,a.board=o;var i=a.cards.map(function(n){return t(n,a)}),c=e(o.columns);n.set({doctype:a.doctype,board:o,card_meta:r,cards:i,columns:c,cur_list:a.cur_list,empty_state:!1,wrapper:a.wrapper})},update_cards:function(n,a){var e=this,o=a.map(function(n){return t(n,e)}).concat(this.cards).uniqBy(function(n){return n.name});n.set({cards:o})},add_column:function(n,a){frappe.model.can_create("Custom Field")?fluxify.doAction("update_column",a,"add"):frappe.msgprint({title:__("Not permitted"),message:__("You are not allowed to create columns"),indicator:"red"})},archive_column:function(n,a){fluxify.doAction("update_column",a,"archive")},restore_column:function(n,a){fluxify.doAction("update_column",a,"restore")},update_column:function(a,t,r){var i=this.doctype,c=this.board;(function(n){return new Promise(function(a){frappe.model.with_doc("Customize Form","Customize Form",function(){var t=frappe.get_doc("Customize Form");t.doc_type=n,frappe.call({doc:t,method:"fetch_to_customize",callback:function(n){a(n.docs[0])}})})})})(i).then(function(n){return function(n,a,t,e){return n.fields.forEach(function(n){if(n.fieldname===a.field_name&&"Select"===n.fieldtype)if(n.options||(n.options=""),"add"===e)n.options.includes(t)||(n.options+="\n"+t);else if("delete"===e){var o=n.options.split("\n"),r=o.indexOf(t);-1!==r&&o.splice(r,1),n.options=o.join("\n")}}),n}(n,c,t.title,r)}).then(o).then(function(){return function(a,t,e){var o,r={board_name:a,column_title:t};"add"===e?o="add_column":"archive"!==e&&"restore"!==e||(o="archive_restore_column",r.status="archive"===e?"Archived":"Active");return frappe.call({method:n+o,args:r})}(c.name,t.title,r)}).then(function(n){var t=n.message;a.set({columns:e(t)})},function(n){console.error(n)})},add_card:function(n,a,e){var o=frappe.model.get_new_doc(this.doctype),r=this.card_meta.title_field,i=this.card_meta.quick_entry,c=this,d={};d[r.fieldname]=a,d[this.board.field_name]=e,this.cur_list.filter_area.get().forEach(function(n){"="===n[2]&&(d[n[1]]=n[3])}),$.extend(o,d);var s=t(o,c);s._disable_click=!0;var u=c.cards.concat([s]),l=o.name;if(n.set({cards:u}),r&&!i)return function(n){return frappe.call({method:"frappe.client.insert",args:{doc:n},callback:function(){frappe.model.clear_doc(n.doctype,n.name),frappe.show_alert({message:__("Saved"),indicator:"green"},1)}})}(o).then(function(a){var e=a.message,o=c.cards.findIndex(function(n){return n.name===l}),r=t(e,c),i=c.cards.slice();i[o]=r,n.set({cards:i}),fluxify.doAction("update_order")});frappe.new_doc(this.doctype,o)},update_card:function(n,a){var t=-1;this.cards.forEach(function(n,e){n.name===a.name&&(t=e)});var e=this.cards.slice();-1!==t&&e.splice(t,1,a),n.set({cards:e})},update_doc:function(a,e,o){var r=this;return frappe.call({method:n+"update_doc",args:{doc:e},freeze:!0}).then(function(n){var a=n.message,e=t(o,r,a);fluxify.doAction("update_card",e)})},update_order:function(t){var o=this.cards.slice(),r=this.columns.slice(),i={};this.wrapper.find(".kanban-column[data-column-value]").each(function(){var n=$(this).data().columnValue;i[n]=[],$(this).find(".kanban-card-wrapper").each(function(){var a=$(this).data().name;i[n].push(a)})}),frappe.call({method:n+"update_order",args:{board_name:this.board.name,order:i},callback:function(n){var o=n.message[0],r=function(n){var t=a.getState().cards;return t.forEach(function(a){n.forEach(function(n){n.name===a.name&&(a.column=n.column)})}),t}(n.message[1]),i=e(o.columns);t.set({cards:r,columns:i})}}).fail(function(){t.set({cards:o,columns:r})})},update_column_order:function(a,t){return frappe.call({method:n+"update_column_order",args:{board_name:this.board.name,order:t}}).then(function(n){var t=e(n.message.columns);a.set({columns:t})})},set_indicator:function(a,t,o){return frappe.call({method:n+"set_indicator",args:{board_name:this.board.name,column_name:t.title,indicator:o}}).then(function(n){var t=e(n.message.columns);a.set({columns:t})})}}});function t(n,a,t){var e=n._assign?JSON.parse(n._assign):[],o=n._comment_count||0;t&&(n=Object.assign({},n,t));for(var r=[],i=0,c=a.board.fields_to_show;i<c.length;i+=1){var d=c[i],s=d.field,u=d.field_title;s&&u&&n[s]&&r.push(u+": "+n[s])}var l="";if("Select"==a.board.board_based_on)l=n[a.board.field_name];else if("Date"==a.board.board_based_on){var f=n[a.board.field_name],p=frappe.datetime.get_day_diff(f,frappe.datetime.get_today());l=0==p?"Today":1==p?"Tomorrow":2==p?"Day After Tomorrow":"Other"}return{doctype:a.doctype,name:n.name,title:n[a.card_meta.title_field.fieldname],column:l,card_properties_display:r,assigned_list:n.assigned_list||e,comment_count:n.comment_count||o,color:n.color||null,doc:t}}function e(n){return n.map(function(n){return{title:n.column_name,status:n.status,order:n.order,indicator:n.indicator||"darkgrey"}})}function o(n){if(n)return n.hide_success=!0,frappe.call({doc:n,method:"save_customization"})}function r(n){return"Archived"!==n.status}frappe.views.KanbanBoard=function(n){var t={};function e(){fluxify.doAction("init",n),a.on("change:columns",o),function(){t.$kanban_board=t.wrapper.find(".kanban"),0===t.$kanban_board.length&&(t.$kanban_board=$(frappe.render_template("kanban_board")),t.$kanban_board.appendTo(t.wrapper));t.$filter_area=t.cur_list.$page.find(".active-tag-filters"),a=t.$kanban_board.find(".add-new-column"),e=a.find(".compose-column"),o=a.find(".compose-column-form").hide(),e.on("click",function(){$(this).hide(),o.show(),o.find("input").focus()}),o.keydown(function(n){if(13==n.which&&(n.preventDefault(),!frappe.request.ajax_count)){var a=o.serializeArray()[0].value,t={title:a.trim()};fluxify.doAction("add_column",t),o.find("input").val(""),e.show(),o.hide()}}),o.find("input").on("blur",function(){$(this).val(""),e.show(),o.hide()}),n=new Sortable(t.$kanban_board.get(0),{group:"columns",animation:150,dataIdAttr:"data-column-value",filter:".add-new-column",handle:".kanban-column-title",onEnd:function(){var a=n.toArray();a=a.slice(1),fluxify.doAction("update_column_order",a)}});var n;var a,e,o}(),a.on("change:cur_list",i),a.on("change:columns",i),a.on("change:empty_state",c)}function o(){t.$kanban_board.find(".kanban-column").not(".add-new-column").remove(),a.getState().columns.filter(r).map(function(n){frappe.views.KanbanBoardColumn(n,t.$kanban_board)})}function i(){var n=a.getState().cur_list,t=a.getState().columns,e=n.$page.find("[data-list-renderer='Kanban'] .list-row-right").css("margin-right","15px");e.empty();var o=t.filter(function(n){return"Archived"===n.status});if(o.length){var r=o.reduce(function(n,a){return n+"<li><a class='option'><span class='ellipsis' style='max-width: 100px; display: inline-block'>"+__(a.title)+"</span><button style='float:right;' data-column='"+a.title+"' class='btn btn-default btn-xs restore-column text-muted'>"+__("Restore")+"</button></a></li>"},""),i=$("<div class='dropdown pull-right'><a class='text-muted dropdown-toggle' data-toggle='dropdown'><span class='dropdown-text'>"+__("Archived Columns")+"</span><i class='caret'></i></a><ul class='dropdown-menu'>"+r+"</ul></div>");e.html(i),i.find(".dropdown-menu").on("click","button.restore-column",function(){var n={title:$(this).data().column,status:"Archived"};fluxify.doAction("restore_column",n)})}}function c(){a.getState().empty_state?(t.$kanban_board.find(".kanban-column").hide(),t.$kanban_board.find(".kanban-empty-state").show()):(t.$kanban_board.find(".kanban-column").show(),t.$kanban_board.find(".kanban-empty-state").hide())}return t.wrapper=n.wrapper,t.cur_list=n.cur_list,t.board_name=n.board_name,t.update=function(a){n.cards=a,t.wrapper.find(".kanban").length>0&&0!==t.cur_list.start?fluxify.doAction("update_cards",a):e()},e(),t},frappe.views.KanbanBoardColumn=function(n,t){var e,o,r,i,c,d={},s=[];function u(){d.$kanban_cards.empty();var t=a.getState().cards,e=(s=function(n,a){return n.filter(function(n){return n.column===a.title})}(t,n)).map(function(n){return n.name}),o=n.order;o?((o=JSON.parse(o)).forEach(function(n){e.includes(n)&&frappe.views.KanbanBoardCard(function(n){return a.getState().cards.find(function(a){return a.name===n})}(n),d.$kanban_cards)}),s.forEach(function(n){-1===o.indexOf(n.name)&&frappe.views.KanbanBoardCard(n,d.$kanban_cards)})):s.map(function(n){frappe.views.KanbanBoardCard(n,d.$kanban_cards)})}d.$kanban_column=$(frappe.render_template("kanban_column",{title:n.title,doctype:a.getState().doctype,indicator:n.indicator})).appendTo(t),d.$kanban_cards=d.$kanban_column.find(".kanban-cards"),Sortable.create(d.$kanban_cards.get(0),{group:"cards",animation:150,dataIdAttr:"data-name",onStart:function(){t.find(".kanban-card.add-card").fadeOut(200,function(){t.find(".kanban-cards").height("100vh")})},onEnd:function(){t.find(".kanban-card.add-card").fadeIn(100),t.find(".kanban-cards").height("auto"),fluxify.doAction("update_order")},onAdd:function(){}}),u(),a.on("change:cards",u),e=d.$kanban_column,o=e.find(".add-card"),r=e.find(".new-card-area"),i=r.find("textarea"),r.hide(),o.on("click",function(){o.hide(),r.show(),i.focus()}),r.keydown(function(a){if(13==a.which&&(a.preventDefault(),!frappe.request.ajax_count)){a.preventDefault();var t=i.val();r.hide(),i.val(""),fluxify.doAction("add_card",t,n.title).then(function(){o.show()})}}),i.on("blur",function(){$(this).val(""),o.show(),r.hide()}),d.$kanban_column.find(".column-options .dropdown-menu").on("click","[data-action]",function(){var a=$(this),t=a.data().action;if("archive"===t)fluxify.doAction("archive_column",n);else if("indicator"===t){var e=a.data().indicator;fluxify.doAction("set_indicator",n,e)}}),c=function(n){var a='<li class="button-group">';a+=n.reduce(function(n,a){return n+'<div \t\t\t\t\t\tdata-action="indicator" data-indicator="'+a+'"\t\t\t\t\t\tclass="btn btn-default btn-xs indicator '+a+'"></div>'},""),a+="</li>",d.$kanban_column.find(".column-options .dropdown-menu").append(a)},frappe.model.with_doctype("Kanban Board Column",function(){var n,a=frappe.get_meta("Kanban Board Column");a.fields.forEach(function(a){"indicator"===a.fieldname&&(n=a.options.split("\n"))}),n||(n=["green","blue","orange","grey"]),c(n)})},frappe.views.KanbanBoardCard=function(n,a){var t,e,o,r={};n&&(t={name:n.name,title:(e=n.title,o=$("<div>"+e+"</div>"),o.find("img").remove(),o.html()),fields_string:n.card_properties_display,disable_click:n._disable_click?"disable-click":""},r.$card=$(frappe.render_template("kanban_card_new",t)).appendTo(a),function(){var a="";if(n.comment_count>0&&(a+='<span class="list-comment-count small text-muted "><i class="octicon octicon-comment"></i> '+n.comment_count+"</span>"),a+=n.assigned_list.reduce(function(n,a){return n+frappe.avatar(a)},""),n.color&&frappe.ui.color.validate_hex(n.color)){var t=$("<div>");$("<div></div>").css({width:"20px",height:"5px",borderRadius:"2px",marginBottom:"4px",backgroundColor:n.color}).appendTo(t),r.$card.find(".kanban-card.content").prepend(t)}r.$card.find(".kanban-card-meta").empty().append(a)}(),r.$card.find(".kanban-card.content").on("click",function(){frappe.set_route("Form",n.doctype,n.name)}))}}(),frappe.templates.kanban_card_new='<div class="kanban-card-wrapper {{ disable_click }}" data-name="{{name}}">  <div class="kanban-card content">   <div class="kanban-card-title">    {{ title }}    <br>    {% for field in fields_string %}     {{ field }}     <br>    {% endfor %}   </div>   <div class="kanban-card-meta">   </div>  </div> </div> '}();
//# sourceMappingURL=erpnext_oralcare.js.map
